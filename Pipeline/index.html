<!DOCTYPE html>
<html>
  <head>
    <title>Kosteus- ja lämpötilaseuranta</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  </head>
  <body>
    <h2>Soitinhuoneen olosuhteet</h2>
    <canvas id="chart"></canvas>
    <p id="alert"></p>

    <script>
      const channelID = "3101346";
      const readAPIKey = "N2H5D7C0K2GSQ4UK";

      async function fetchData() {
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=20&api_key=${readAPIKey}`;
        const response = await fetch(url);
        const data = await response.json();

        const temps = data.feeds.map((f) => ({
          x: f.created_at,
          y: parseFloat(f.field1),
        }));
        const hums = data.feeds.map((f) => ({
          x: f.created_at,
          y: parseFloat(f.field2),
        }));
        const alerts = data.feeds.map((f) => parseInt(f.field3));

        // Näytä alert jos viimeisin = 1
        if (alerts[alerts.length - 1] === 1) {
          document.getElementById("alert").innerText =
            "⚠️ Hälytys: Raja-arvot ylitetty!";
        } else {
          document.getElementById("alert").innerText = "Kaikki ok.";
        }

        new Chart(document.getElementById("chart"), {
          type: "line",
          data: {
            datasets: [
              {
                label: "Lämpötila (°C)",
                data: temps,
                borderWidth: 2,
              },
              {
                label: "Kosteus (%)",
                data: hums,
                borderWidth: 2,
              },
            ],
          },
          options: {
            scales: {
              x: {
                type: "time",
                time: {
                  tooltipFormat: "yyyy-MM-dd HH:mm",
                  displayFormats: {
                    minute: "HH:mm",
                    hour: "HH:mm",
                  },
                },
                title: {
                  display: true,
                  text: "Aika",
                },
              },
            },
          },
        });
      }

      fetchData();
      setInterval(fetchData, 20000); // päivitys 20s välein
    </script>
  </body>
</html>
